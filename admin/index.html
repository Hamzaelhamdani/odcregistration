<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Back-Office ODC - Administration</title>
    <link rel="icon" type="image/svg+xml" href="../logo.svg">
    <link rel="stylesheet" href="css/admin.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/events.css">
    <link rel="stylesheet" href="css/placeholders.css">
    <link rel="stylesheet" href="css/image-upload.css">
    
        <!-- Chargement des scripts dans le bon ordre -->
    <!-- 1. Librairie Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    
    <!-- 2. Variables d'environnement -->
    <script src="../env.js"></script>
    
    <!-- 3. API Supabase -->
    <script src="../config/supabase.js"></script>
    
    <!-- 4. Authentification -->
    <script src="js/auth.js"></script>
    
    <!-- 5. Utilitaires -->
    <script src="js/image-utils.js"></script>
    
        <!-- 6. Gestionnaires -->
    <script src="js/image-handlers.js"></script>
    <script src="js/form-handlers.js"></script>
    <script src="js/add-handlers.js"></script>
    <script src="js/events-manager.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/admin-supabase.js"></script>
    <script src="js/form-upload.js"></script>
    <script src="js/image-zoom.js"></script>
    <script src="js/init-admin.js"></script>
    
    <script>
        // Emp√™cher l'acc√®s direct √† la page sans authentification
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const loader = document.getElementById('authLoader');
                const mainContent = document.querySelector('.admin-layout');
                
                // Attendre que l'API Supabase soit initialis√©e
                let attempts = 0;
                while (!window.SupabaseAPI?.initialized && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                    console.log('‚è≥ Attente de Supabase...', attempts);
                }
                
                if (!window.SupabaseAPI?.initialized) {
                    throw new Error('Timeout: Supabase non initialis√© apr√®s 5 secondes');
                }
                
                console.log('‚úÖ Supabase est pr√™t √† √™tre utilis√©');
                
                // V√©rifier l'authentification
                if (!window.authManager) {
                    throw new Error('Le script d\'authentification n\'est pas charg√©');
                }
                
                // V√©rifier la session stock√©e
                const storedSession = localStorage.getItem('adminSession');
                if (storedSession) {
                    const { timestamp, email } = JSON.parse(storedSession);
                    console.log('‚úì Session trouv√©e pour:', email);
                }
                
                // Si l'authentification est r√©ussie, cacher le loader
                if (!await window.authManager.requireAuth()) {
                    if (loader) {
                        loader.innerHTML = `
                            <i class="fas fa-lock" style="font-size: 3rem; color: #dc3545; margin-block-end: 1rem;"></i>
                            <h2 style="color: #dc3545; margin: 0;">Acc√®s non autoris√©</h2>
                            <p style="color: #666; margin-block-start: 0.5rem;">Redirection vers la page de connexion...</p>
                        `;
                    }
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                console.log('‚úÖ Authentification r√©ussie');
                
                if (loader) loader.style.display = 'none';
                if (mainContent) mainContent.style.visibility = 'visible';
                
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                console.log('‚è≥ Redirection vers login...');
                window.location.href = 'login.html';
            }
        });
    </script>
</head>
<body>
    <div id="authLoader" style="position: fixed; inset-block: 0; inset-inline: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: 'Open Sans', sans-serif;">
        <i class="fas fa-shield-alt" style="font-size: 3rem; color: #FF7900; margin-block-end: 1rem;"></i>
        <h2 style="color: #333; margin: 0;">V√©rification des permissions...</h2>
        <p style="color: #666; margin-block-start: 0.5rem;">Patientez pendant que nous v√©rifions votre authentification.</p>
    </div>
    
    <script>
        // Ajouter un gestionnaire d'erreurs global
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('üö® Erreur globale:', {
                message: msg,
                url: url,
                line: lineNo,
                column: columnNo,
                error: error
            });
            return false;
        };
    </script>
    
    <div class="admin-layout" style="visibility: hidden;">
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="admin-logo">
                    <div class="logo-orange-square">
                        <span class="logo-orange-text">orange</span>
                    </div>
                    <div class="logo-text">
                        <span class="admin-title">Admin ODC</span>
                    </div>
                </div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#dashboard" class="nav-link" data-page="dashboard">
                        <i class="fas fa-dashboard"></i>
                        <span>Tableau de bord</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#formations" class="nav-link" data-page="formations">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Formations</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#events" class="nav-link" data-page="events">
                        <i class="fas fa-calendar-alt"></i>
                        <span>√âv√©nements</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#settings" class="nav-link" data-page="settings">
                        <i class="fas fa-cog"></i>
                        <span>Param√®tres</span>
                    </a>
                </li>
                <li class="nav-item">
                    <button class="nav-link diagnostic-btn" onclick="runODCDiagnostics()" style="border: none; background: none; inline-size: 100%; text-align: start; cursor: pointer; color: inherit; padding: 0.75rem 1.5rem;">
                        <i class="fas fa-stethoscope"></i>
                        <span>Diagnostic syst√®me</span>
                    </button>
                </li>
                <li class="nav-item">
                    <a href="../index.html" class="nav-link" target="_blank">
                        <i class="fas fa-external-link-alt"></i>
                        <span>Voir le site</span>
                    </a>
                </li>
            </ul>
        </nav>

        
        <main class="main-content">
            
            <header class="content-header">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="pageTitle">Tableau de bord</h1>
                </div>
                
                <div class="header-right">
                    <div class="header-actions">
                        <button class="btn btn-outline-secondary" id="testStorageBtn" title="Tester la connexion Supabase Storage">
                            <i class="fas fa-cloud-upload-alt"></i>
                            Test Stockage
                        </button>
                        <button class="btn btn-outline-info" id="testEventsBtn" title="Tester le chargement des √©v√©nements">
                            <i class="fas fa-calendar-check"></i>
                            Test √âv√©nements
                        </button>
                        <button class="btn btn-primary" id="addNewBtn">
                            <i class="fas fa-plus"></i>
                            Ajouter
                        </button>
                    </div>
                </div>
            </header>

            
            <div class="content-wrapper">
                
                <div id="dashboard-page" class="content-page active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-graduation-cap"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="totalFormations">0</h3>
                                <p>Formations actives</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="totalEvents">0</h3>
                                <p>√âv√©nements programm√©s</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="totalParticipants">0</h3>
                                <p>Participants inscrits</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="totalCenters">4</h3>
                                <p>Centres ODC</p>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="dashboard-section">
                            <h3>Activit√©s r√©centes</h3>
                            <div class="recent-activities" id="recentActivities">
                                
                            </div>
                        </div>
                        
                        <div class="dashboard-section">
                            <h3>Prochains √©v√©nements</h3>
                            <div class="upcoming-events" id="upcomingEvents">
                                
                            </div>
                        </div>
                    </div>
                </div>

                
                <div id="formations-page" class="content-page">
                    <div class="page-controls">
                        <div class="search-bar">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Rechercher une formation..." id="searchFormations">
                        </div>
                        <div class="filter-controls">
                            <select id="categoryFilter">
                                <option value="">Toutes les cat√©gories</option>
                                <option value="ecole-du-code">√âcole du Code</option>
                                <option value="fablab">FabLab</option>
                            </select>
                            <select id="cityFilter">
                                <option value="">Toutes les villes</option>
                                <option value="rabat">Rabat</option>
                                <option value="agadir">Agadir</option>
                                <option value="benmisk">Ben M'sik</option>
                                <option value="sidimaarouf">Sidi Maarouf</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <table class="data-table" id="formationsTable">
                            <thead>
                                <tr>
                                    <th>Titre</th>
                                    <th>Cat√©gorie</th>
                                    <th>Date</th>
                                    <th>Lieu</th>
                                    <th>Participants</th>
                                    <th>Inscription</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="formationsTableBody">
                                
                            </tbody>
                        </table>
                    </div>
                </div>

                
                <div id="events-page" class="content-page">
                    <div class="section-header">
                        <h2><i class="fas fa-calendar-alt"></i> Gestion des √©v√©nements</h2>
                        <button class="btn btn-primary" onclick="handleAddNew()">
                            <i class="fas fa-plus"></i> Nouvel √©v√©nement
                        </button>
                    </div>
                    
                    <div class="events-toolbar">
                        <div class="search-bar">
                            <i class="fas fa-search"></i>
                            <input type="text" id="eventSearch" placeholder="Rechercher un √©v√©nement...">
                        </div>
                        
                        <div class="filters">
                            <select id="cityFilter">
                                <option value="">Toutes les villes</option>
                                <option value="rabat">Rabat</option>
                                <option value="agadir">Agadir</option>
                                <option value="benmisk">Ben M'sik</option>
                                <option value="sidimaarouf">Sidi Maarouf</option>
                            </select>
                            
                            <select id="statusFilter">
                                <option value="">Tous les statuts</option>
                                <option value="active">Actifs</option>
                                <option value="completed">Termin√©s</option>
                                <option value="cancelled">Annul√©s</option>
                            </select>
                        </div>
                    </div>

                    <div id="eventsGrid" class="events-grid"></div>
                </div>

                
                <div id="settings-page" class="content-page">
                    <div class="settings-grid">
                        <div class="settings-section">
                            <h3>Param√®tres g√©n√©raux</h3>
                            <form id="generalSettingsForm">
                                <div class="form-group">
                                    <label for="siteTitle">Titre du site</label>
                                    <input type="text" id="siteTitle" name="siteTitle" placeholder="Orange Digital Center - Formations & √âv√©nements du Mois">
                                </div>
                                
                                <div class="form-group">
                                    <label for="siteDescription">Description</label>
                                    <textarea id="siteDescription" name="siteDescription" rows="3" placeholder="D√©veloppez vos comp√©tences digitales avec l'Orange Digital Center"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="heroTitle">Titre Hero</label>
                                    <input type="text" id="heroTitle" name="heroTitle" placeholder="D√©veloppez vos comp√©tences digitales">
                                </div>
                                
                                <div class="form-group">
                                    <label for="heroSubtitle">Sous-titre Hero</label>
                                    <textarea id="heroSubtitle" name="heroSubtitle" rows="2" placeholder="D√©couvrez nos formations et √©v√©nements dans tous nos centres Orange Digital Center"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="contactEmail">Email de contact</label>
                                    <input type="email" id="contactEmail" name="contactEmail" placeholder="contact@orangedigitalcenter.ma">
                                </div>
                                
                                <button type="submit" class="btn btn-primary">Enregistrer les param√®tres</button>
                            </form>
                        </div>
                        
                        <div class="settings-section">
                            <h3>Centres ODC</h3>
                            <div id="odcCentersList">
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    
    <div id="modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle"></h3>
                    <button id="modalClose" class="modal-close" onclick="closeModal()">√ó</button>
                </div>
                <div id="modalBody" class="modal-body"></div>
            </div>
        </div>
    </div>

    <script src="js/diagnostic.js"></script>
    
    <script>
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
    
    <script>
        // Initialisation et r√©initialisation de l'application
        async function initializeApp() {
            try {
                console.log('üîÑ Initialisation de l\'application...');
                
                // Attendre que l'API soit initialis√©e
                let attempts = 0;
                while (!window.SupabaseAPI?.initialized && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.SupabaseAPI?.initialized) {
                    throw new Error('Timeout: API Supabase non initialis√©e');
                }
                
                console.log('‚úÖ Supabase est pr√™t');
                
                // V√©rifier la connexion √† la base de donn√©es
                const { data, error } = await window.supabaseClient.from('formations').select('count');
                if (error) throw error;
                console.log('‚úÖ Connexion √† la base de donn√©es v√©rifi√©e');
                
                // V√©rifier la session
                const { data: { session }, error: sessionError } = 
                    await window.supabaseClient.auth.getSession();
                
                if (sessionError || !session) {
                    throw new Error('Session invalide');
                }
                
                // Initialiser le dashboard si la fonction existe
                if (typeof initializeDashboard === 'function') {
                    console.log('üîÑ Initialisation du dashboard...');
                    await initializeDashboard();
                }
                
                // Actualiser l'interface
                if (typeof loadAllData === 'function') {
                    console.log('üîÑ Chargement des donn√©es...');
                    await loadAllData();
                }
                
                console.log('‚úÖ Application initialis√©e avec succ√®s');
                
            } catch (error) {
                console.error('‚ùå Erreur d\'initialisation:', error);
                if (error.message === 'Session invalide') {
                    console.log('‚è≥ Redirection vers login...');
                    window.location.href = 'login.html';
                    return;
                }
                
                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.textContent = 'Erreur: ' + error.message;
                    errorMessage.style.display = 'block';
                }
            }
        }
        
        // D√©marrer l'initialisation
        initializeApp();
    </script>
</body>
</html>
